<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>抽獎金額記錄系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .input-group {
            margin: 10px 0;
        }
        button {
            padding: 5px 10px;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <h1>抽獎金額記錄系統</h1>

    <div class="input-group">
        <label>新增使用者名稱: 
            <input type="text" id="newUser" placeholder="輸入新使用者名稱">
            <button onclick="addUser()">新增使用者</button>
        </label>
    </div>

    <div class="input-group">
        <label>選擇用戶: 
            <select id="user"></select>
        </label>
        
        <label>選擇銀行: 
            <select id="bank">
                <option value="中銀">中銀</option>
                <option value="大豐">大豐</option>
                <option value="工商">工商</option>
                <option value="MPAY">MPAY</option>
                <option value="支付寶">支付寶</option>
                <option value="UEPAY">UEPAY</option>
                <option value="雲閃付">雲閃付</option>
            </select>
        </label>
        
        <label>抽獎金額: 
            <input type="number" id="amount" min="0">
        </label>
        
        <label>抽獎日期: 
            <input type="date" id="drawDate">
        </label>
        
        <button onclick="addRecord()">新增記錄</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>用戶</th>
                <th>銀行</th>
                <th>抽獎金額</th>
                <th>抽獎日期</th>
                <th>使用期限</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
    </table>

    <script>
        // 初始化資料
        let users = JSON.parse(localStorage.getItem('users')) || ['東', 'IRIS'];
        let records = JSON.parse(localStorage.getItem('drawRecords')) || [];

        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('drawRecords', JSON.stringify(records));
        }

        function updateUserSelect() {
            const userSelect = document.getElementById('user');
            userSelect.innerHTML = '';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.text = user;
                userSelect.appendChild(option);
            });
        }

        function addUser() {
            const newUser = document.getElementById('newUser').value.trim();
            if (newUser && !users.includes(newUser)) {
                users.push(newUser);
                saveData();
                updateUserSelect();
                document.getElementById('newUser').value = '';
                alert('已新增使用者: ' + newUser);
            } else if (!newUser) {
                alert('請輸入使用者名稱');
            } else {
                alert('此使用者名稱已存在');
            }
        }

        function getWeekendDates(drawDate) {
            const date = new Date(drawDate);
            const day = date.getDay();
            const diffToSaturday = day === 0 ? -1 : 6 - day;
            const saturday = new Date(date);
            saturday.setDate(date.getDate() + diffToSaturday);
            
            const sunday = new Date(saturday);
            sunday.setDate(saturday.getDate() + 1);
            
            return `${saturday.toLocaleDateString('zh-HK')} - ${sunday.toLocaleDateString('zh-HK')}`;
        }

        function addRecord() {
            const user = document.getElementById('user').value;
            const bank = document.getElementById('bank').value;
            const amount = document.getElementById('amount').value;
            const drawDate = document.getElementById('drawDate').value;

            if (!amount || !drawDate) {
                alert('請填寫金額和抽獎日期');
                return;
            }

            const record = {
                id: Date.now(), // 唯一ID
                user,
                bank,
                amount: parseFloat(amount),
                drawDate,
                expiry: getWeekendDates(drawDate)
            };

            records.push(record);
            saveData();
            displayRecords();
        }

        function deleteRecord(id) {
            // 只刪除指定ID的單筆記錄
            records = records.filter(record => record.id !== id);
            saveData();
            displayRecords();
        }

        function displayRecords() {
            const tbody = document.getElementById('recordsTable');
            tbody.innerHTML = '';
            const selectedUser = document.getElementById('user').value;
            
            // 只顯示當前選擇用戶的記錄
            records
                .filter(record => record.user === selectedUser)
                .forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.user}</td>
                        <td>${record.bank}</td>
                        <td>${record.amount}</td>
                        <td>${record.drawDate}</td>
                        <td>${record.expiry}</td>
                        <td><button onclick="deleteRecord(${record.id})">刪除</button></td>
                    `;
                    tbody.appendChild(row);
                });
        }

        function checkMondayReset() {
            const today = new Date();
            if (today.getDay() === 1) { // 星期一
                const lastReset = localStorage.getItem('lastReset');
                const todayStr = today.toDateString();
                
                if (lastReset !== todayStr) {
                    records = []; // 每週一清空所有記錄
                    saveData();
                    localStorage.setItem('lastReset', todayStr);
                    displayRecords();
                }
            }
        }

        // 初始化
        updateUserSelect();
        checkMondayReset();
        displayRecords();

        // 當選擇不同用戶時更新顯示
        document.getElementById('user').addEventListener('change', displayRecords);

        // 每分鐘檢查一次是否需要重置
        setInterval(checkMondayReset, 60000);
    </script>
</body>
</html>
